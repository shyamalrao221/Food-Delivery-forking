pipeline {
    agent {
        docker {
            image 'node:lts'
            // MOUNTS EXPLAINED:
            // 1. /var/run/docker.sock: Connects to host Docker engine
            // 2. /usr/bin & /usr/lib: Shares host system binaries (needed for gcloud helper)
            // 3. /usr/local/bin/kubectl: Shares the kubectl tool
            // 4. /home/shyam: Shares certificates and kubeconfig
            args '''--network host 
                    -u root 
                    -v /var/run/docker.sock:/var/run/docker.sock 
                    -v /usr/bin:/usr/bin 
                    -v /usr/lib:/usr/lib
                    -v /usr/local/bin/kubectl:/usr/local/bin/kubectl 
                    -v /home/shyam:/home/shyam 
                    -e KUBECONFIG=/home/shyam/.kube/config'''
        }
    }

    environment {
        PROJECT_ID = 'ha-demo-480714'
        LOCATION = 'us-central1'
        REPO_NAME = 'my-app-repo'
        DOCKER_REGISTRY = "${LOCATION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}"
        
        FRONTEND_IMAGE_NAME = "food-delivery-frontend"
        BACKEND_IMAGE_NAME = "food-delivery-backend"
        ADMIN_IMAGE_NAME = "food-delivery-admin"
        VERSION = "${env.BUILD_NUMBER}"
    }

    stages {
        stage('Build: App Assets') {
            steps {
                echo "Installing dependencies and building assets..."
                dir('admin') { sh 'npm install --silent && npm run build' }
                dir('frontend') { sh 'npm install --silent && npm run build' }
                dir('backend') { sh 'npm install --silent' }
            }
        }

        stage('Docker Build and Push to GCP') {
            steps {
                script {
                    // This 'gcp-auth-key' must be a 'Secret File' type in Jenkins
                    withCredentials([file(credentialsId: 'gcp-auth-key', variable: 'GCP_KEY_FILE')]) {
                        
                        echo "Installing Google Cloud SDK into Workspace..."
                        sh '''
                            # Clean old install and install new into shared Workspace
                            rm -rf ${WORKSPACE}/google-cloud-sdk
                            apt-get update && apt-get install -y curl python3
                            curl -o install.sh -sSL https://sdk.cloud.google.com
                            bash install.sh --disable-prompts --install-dir=${WORKSPACE} > /dev/null
                            
                            # Create symlink so Host Docker Daemon can find the login helper
                            ln -sf ${WORKSPACE}/google-cloud-sdk/bin/docker-credential-gcloud /usr/bin/docker-credential-gcloud
                        '''
                        
                        def SDK_BIN = "${WORKSPACE}/google-cloud-sdk/bin"
                        
                        withEnv(["PATH+GCLOUD=${SDK_BIN}"]) {
                            echo "Authenticating with GCP..."
                            sh "gcloud auth activate-service-account --key-file=${GCP_KEY_FILE}"
                            sh "gcloud auth configure-docker ${LOCATION}-docker.pkg.dev --quiet"

                            echo "Pushing Images to Artifact Registry..."
                            
                            // Backend
                            sh "docker build -t ${DOCKER_REGISTRY}/${BACKEND_IMAGE_NAME}:${VERSION} ./backend"
                            sh "docker push ${DOCKER_REGISTRY}/${BACKEND_IMAGE_NAME}:${VERSION}"

                            // Frontend
                            sh "docker build -t ${DOCKER_REGISTRY}/${FRONTEND_IMAGE_NAME}:${VERSION} ./frontend"
                            sh "docker push ${DOCKER_REGISTRY}/${FRONTEND_IMAGE_NAME}:${VERSION}"
                            
                            // Admin
                            sh "docker build -t ${DOCKER_REGISTRY}/${ADMIN_IMAGE_NAME}:${VERSION} ./admin"
                            sh "docker push ${DOCKER_REGISTRY}/${ADMIN_IMAGE_NAME}:${VERSION}"
                        }
                    }
                }
            }
        }

stage('Deploy to Kubernetes') {
            steps {
                echo "Updating manifests and deploying to GKE..."
                script {
                    def SDK_BIN = "${WORKSPACE}/google-cloud-sdk/bin"
                    
                    withEnv(["PATH+GCLOUD=${SDK_BIN}"]) {
                        // 1. Point kubectl to your specific GKE cluster
                        sh "gcloud container clusters get-credentials my-practice-cluster --region ${LOCATION} --project ${PROJECT_ID}"

                        // 2. Deploy Frontend
                        sh "sed -i 's|image: .*|image: ${DOCKER_REGISTRY}/${FRONTEND_IMAGE_NAME}:${VERSION}|g' frontend/deployment.yml"
                        sh "kubectl apply -f frontend/deployment.yml"

                        // 3. Deploy Backend
                        sh "sed -i 's|image: .*|image: ${DOCKER_REGISTRY}/${BACKEND_IMAGE_NAME}:${VERSION}|g' backend/deployment.yml"
                        sh "kubectl apply -f backend/deployment.yml"

                        // 4. Deploy Admin
                        sh "sed -i 's|image: .*|image: ${DOCKER_REGISTRY}/${ADMIN_IMAGE_NAME}:${VERSION}|g' admin/deployment.yml"
                        sh "kubectl apply -f admin/deployment.yml"
                    }
                }
            }
        }

    post {
        success { echo 'Full CI/CD Cycle Complete! Images pushed and GKE updated.' }
        failure { echo 'Pipeline failed. Check Console Output for specific stage error.' }
    }
}
